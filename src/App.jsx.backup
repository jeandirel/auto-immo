import { useState, createContext, useContext } from 'react'
import { BrowserRouter, Routes, Route, Link, useNavigate, Navigate } from 'react-router-dom'
import { Home, Car, Building, Laptop, Search, Plus, Share2, Phone, Mail, LogIn, LogOut, User, Upload, X } from 'lucide-react'
import FormulaireIntelligent from './FormulaireIntelligent'

// Context d'authentification
const AuthContext = createContext()

function AuthProvider({ children }) {
    const [user, setUser] = useState(() => {
        const savedUser = localStorage.getItem('user')
        return savedUser ? JSON.parse(savedUser) : null
    })

    const login = (email, password) => {
        if (email === 'admin@auto-immo.ga' && password === 'admin') {
            const userData = { email, role: 'admin', nom: 'Administrateur' }
            setUser(userData)
            localStorage.setItem('user', JSON.stringify(userData))
            return true
        }
        return false
    }

    const logout = () => {
        setUser(null)
        localStorage.removeItem('user')
    }

    return (
        <AuthContext.Provider value={{ user, login, logout }}>
            {children}
        </AuthContext.Provider>
    )
}

const useAuth = () => useContext(AuthContext)

// Donn√©es d'exemple
const ANNONCES_DATA = [
    {
        id: 1,
        titre: 'Villa moderne 4 chambres - Libreville',
        prix: 85000000,
        categorie: 'immobilier',
        type: 'vente',
        ville: 'Libreville',
        quartier: 'Glass',
        description: 'Magnifique villa moderne avec 4 chambres, salon spacieux, cuisine √©quip√©e. Jardin et garage.',
        photos: ['https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800'],
        contact: { nom: 'Jean Koumba', tel: '+241 06 12 34 56', email: 'j.koumba@example.com' },
        details: { surface: 250, chambres: 4 }
    },
    {
        id: 2,
        titre: 'Toyota Land Cruiser 2020',
        prix: 25000000,
        categorie: 'vehicules',
        type: 'vente',
        ville: 'Port-Gentil',
        description: 'Land Cruiser en excellent √©tat, 45000 km, toutes options.',
        photos: ['https://images.unsplash.com/photo-1533473359331-0135ef1b58bf?w=800'],
        contact: { nom: 'Marie Obame', tel: '+241 07 23 45 67' },
        details: { marque: 'Toyota', modele: 'Land Cruiser', annee: 2020, kilometrage: 45000 }
    },
    {
        id: 3,
        titre: 'MacBook Pro 16" M2 Pro',
        prix: 1800000,
        categorie: 'informatique',
        type: 'vente',
        ville: 'Libreville',
        description: 'MacBook Pro 16" M2 Pro, 16GB RAM, 512GB SSD. Comme neuf, facture disponible.',
        photos: ['https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=800'],
        contact: { nom: 'David Ndong', tel: '+241 06 34 56 78' },
        details: { marque: 'Apple', modele: 'MacBook Pro', etat: 'Comme neuf' }
    },
]

const VILLES = ['Libreville', 'Port-Gentil', 'Franceville', 'Oyem', 'Moanda']
const CATEGORIES = [
    { key: 'immobilier', label: 'Immobilier', icon: Building },
    { key: 'vehicules', label: 'V√©hicules', icon: Car },
    { key: 'informatique', label: 'Informatique', icon: Laptop },
]

// Composants
function Navbar() {
    const { user, logout } = useAuth()
    const navigate = useNavigate()

    return (
        <nav className="bg-gradient-to-r from-gabon-green via-primary to-secondary text-white shadow-lg">
            <div className="container mx-auto px-4 py-4">
                <div className="flex items-center justify-between">
                    <Link to="/" className="text-2xl font-bold">AUTO-IMMO</Link>
                    <div className="flex gap-4 items-center">
                        <Link to="/" className="hover:text-gabon-yellow transition">Accueil</Link>

                        {user ? (
                            <>
                                {user.role === 'admin' && (
                                    <Link to="/nouvelle-annonce" className="flex items-center gap-2 bg-white text-primary px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                                        <Plus size={20} />
                                        Publier
                                    </Link>
                                )}
                                <div className="flex items-center gap-2">
                                    <div className="flex items-center gap-2 bg-white/20 px-3 py-2 rounded-lg">
                                        <User size={16} />
                                        <span className="text-sm">{user.nom}</span>
                                    </div>
                                    <button
                                        onClick={() => {
                                            logout()
                                            navigate('/')
                                        }}
                                        className="flex items-center gap-2 bg-white/20 px-4 py-2 rounded-lg hover:bg-white/30 transition"
                                    >
                                        <LogOut size={20} />
                                        D√©connexion
                                    </button>
                                </div>
                            </>
                        ) : (
                            <Link to="/login" className="flex items-center gap-2 bg-white text-primary px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                                <LogIn size={20} />
                                Connexion Admin
                            </Link>
                        )}
                    </div>
                </div>
            </div>
        </nav>
    )
}

function HomePage() {
    const navigate = useNavigate()
    const [filters, setFilters] = useState({ categorie: '', ville: '', search: '' })

    const filteredAnnonces = ANNONCES_DATA.filter(annonce => {
        if (filters.categorie && annonce.categorie !== filters.categorie) return false
        if (filters.ville && annonce.ville !== filters.ville) return false
        if (filters.search && !annonce.titre.toLowerCase().includes(filters.search.toLowerCase())) return false
        return true
    })

    return (
        <div>
            {/* Hero */}
            <div className="bg-gradient-to-r from-gabon-green via-primary to-secondary text-white py-16">
                <div className="container mx-auto px-4 text-center">
                    <h1 className="text-5xl font-bold mb-4">Trouvez le bien qui vous ressemble</h1>
                    <p className="text-xl mb-8">Immobilier, v√©hicules et mat√©riel informatique au Gabon</p>

                    {/* Filtres */}
                    <div className="bg-white rounded-lg p-6 text-gray-800 max-w-4xl mx-auto">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <select
                                className="border rounded-lg px-4 py-2"
                                value={filters.categorie}
                                onChange={(e) => setFilters({ ...filters, categorie: e.target.value })}
                            >
                                <option value="">Toutes cat√©gories</option>
                                {CATEGORIES.map(cat => <option key={cat.key} value={cat.key}>{cat.label}</option>)}
                            </select>

                            <select
                                className="border rounded-lg px-4 py-2"
                                value={filters.ville}
                                onChange={(e) => setFilters({ ...filters, ville: e.target.value })}
                            >
                                <option value="">Toutes villes</option>
                                {VILLES.map(ville => <option key={ville} value={ville}>{ville}</option>)}
                            </select>

                            <div className="relative">
                                <input
                                    type="text"
                                    placeholder="Rechercher..."
                                    className="border rounded-lg px-4 py-2 w-full pl-10"
                                    value={filters.search}
                                    onChange={(e) => setFilters({ ...filters, search: e.target.value })}
                                />
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Cat√©gories */}
            <div className="container mx-auto px-4 py-12">
                <h2 className="text-3xl font-bold mb-8">Nos cat√©gories</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {CATEGORIES.map(cat => {
                        const Icon = cat.icon
                        const count = ANNONCES_DATA.filter(a => a.categorie === cat.key).length
                        return (
                            <button
                                key={cat.key}
                                onClick={() => setFilters({ ...filters, categorie: cat.key })}
                                className="border-2 border-gray-200 rounded-lg p-6 hover:border-primary transition text-center group"
                            >
                                <Icon className="mx-auto mb-4 text-primary group-hover:scale-110 transition" size={48} />
                                <h3 className="text-xl font-semibold mb-2">{cat.label}</h3>
                                <p className="text-gray-600">{count} annonces</p>
                            </button>
                        )
                    })}
                </div>
            </div>

            {/* Liste annonces */}
            <div className="container mx-auto px-4 py-12">
                <h2 className="text-3xl font-bold mb-8">Derni√®res annonces ({filteredAnnonces.length})</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {filteredAnnonces.map(annonce => (
                        <div
                            key={annonce.id}
                            onClick={() => navigate(`/annonce/${annonce.id}`)}
                            className="border rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition cursor-pointer"
                        >
                            <img src={annonce.photos[0]} alt={annonce.titre} className="w-full h-48 object-cover" />
                            <div className="p-4">
                                <div className="flex justify-between items-start mb-2">
                                    <h3 className="font-semibold text-lg">{annonce.titre}</h3>
                                    <span className="text-primary font-bold">{annonce.prix.toLocaleString()} FCFA</span>
                                </div>
                                <p className="text-gray-600 text-sm mb-2">{annonce.ville}</p>
                                <p className="text-gray-700 text-sm line-clamp-2">{annonce.description}</p>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    )
}

function DetailAnnonce() {
    const id = parseInt(window.location.pathname.split('/').pop())
    const annonce = ANNONCES_DATA.find(a => a.id === id)

    if (!annonce) return <div className="container mx-auto px-4 py-12">Annonce non trouv√©e</div>

    const shareUrl = window.location.href

    return (
        <div className="container mx-auto px-4 py-12">
            <button onClick={() => window.history.back()} className="text-primary mb-6">‚Üê Retour</button>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <img src={annonce.photos[0]} alt={annonce.titre} className="w-full rounded-lg shadow-lg" />
                </div>

                <div>
                    <h1 className="text-3xl font-bold mb-4">{annonce.titre}</h1>
                    <p className="text-4xl text-primary font-bold mb-6">{annonce.prix.toLocaleString()} FCFA</p>

                    <div className="mb-6">
                        <p className="text-gray-600 mb-2"><strong>Ville:</strong> {annonce.ville}</p>
                        {annonce.quartier && <p className="text-gray-600 mb-2"><strong>Quartier:</strong> {annonce.quartier}</p>}
                        <p className="text-gray-600 mb-4"><strong>Type:</strong> {annonce.type}</p>
                        <p className="text-gray-700">{annonce.description}</p>
                    </div>

                    {/* Contact */}
                    <div className="bg-gray-100 rounded-lg p-6 mb-6">
                        <h3 className="font-semibold mb-4">Contact</h3>
                        <p className="mb-2"><Phone className="inline mr-2" size={16} />{annonce.contact.tel}</p>
                        {annonce.contact.email && <p><Mail className="inline mr-2" size={16} />{annonce.contact.email}</p>}
                    </div>

                    {/* Partage */}
                    <div>
                        <h3 className="font-semibold mb-4">Partager</h3>
                        <div className="flex gap-2">
                            <a
                                href={`https://wa.me/?text=${encodeURIComponent(annonce.titre + ' - ' + shareUrl)}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition"
                            >
                                WhatsApp
                            </a>
                            <a
                                href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                            >
                                Facebook
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    )
}

function LoginPage() {
    const [email, setEmail] = useState('')
    const [password, setPassword] = useState('')
    const [error, setError] = useState('')
    const { login } = useAuth()
    const navigate = useNavigate()

    const handleSubmit = (e) => {
        e.preventDefault()
        setError('')

        if (login(email, password)) {
            navigate('/')
        } else {
            setError('Identifiants incorrects. Utilisez : admin@auto-immo.ga / admin')
        }
    }

    return (
        <div className="container mx-auto px-4 py-12">
            <div className="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
                <h1 className="text-3xl font-bold mb-6 text-center">Connexion Admin</h1>

                {error && (
                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                        {error}
                    </div>
                )}

                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block mb-2 font-semibold">Email</label>
                        <input
                            type="email"
                            required
                            className="w-full border rounded-lg px-4 py-2"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            placeholder="admin@auto-immo.ga"
                        />
                    </div>

                    <div>
                        <label className="block mb-2 font-semibold">Mot de passe</label>
                        <input
                            type="password"
                            required
                            className="w-full border rounded-lg px-4 py-2"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        />
                    </div>

                    <button
                        type="submit"
                        className="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition font-semibold"
                    >
                        Se connecter
                    </button>
                </form>

                <div className="mt-6 p-4 bg-gray-100 rounded-lg">
                    <p className="text-sm text-gray-600 font-semibold mb-2">üìù Identifiants de d√©mo :</p>
                    <p className="text-xs text-gray-600">Email : admin@auto-immo.ga</p>
                    <p className="text-xs text-gray-600">Mot de passe : admin</p>
                </div>
            </div>
        </div>
    )
}

function NouvelleAnnonce() {
    const { user } = useAuth()
    const navigate = useNavigate()
    const [formData, setFormData] = useState({
        titre: '',
        prix: '',
        categorie: 'immobilier',
        type: 'vente',
        ville: 'Libreville',
        description: '',
    })
    const [photos, setPhotos] = useState([])
    const [isDragging, setIsDragging] = useState(false)

    const processFiles = (files) => {
        files.forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader()
                reader.onloadend = () => {
                    setPhotos(prev => [...prev, {
                        file,
                        preview: reader.result,
                        name: file.name
                    }])
                }
                reader.readAsDataURL(file)
            }
        })
    }

    const handleImageUpload = (e) => {
        const files = Array.from(e.target.files)
        processFiles(files)
    }

    const handleDragOver = (e) => {
        e.preventDefault()
        setIsDragging(true)
    }

    const handleDragLeave = (e) => {
        e.preventDefault()
        setIsDragging(false)
    }

    const handleDrop = (e) => {
        e.preventDefault()
        setIsDragging(false)
        const files = Array.from(e.dataTransfer.files)
        processFiles(files)
    }

    const removePhoto = (index) => {
        setPhotos(prev => prev.filter((_, i) => i !== index))
    }

    const handleSubmit = (e) => {
        e.preventDefault()

        if (photos.length === 0) {
            alert('Veuillez ajouter au moins une photo')
            return
        }

        const newAnnonce = {
            ...formData,
            photos: photos.map(p => p.preview),
            id: Date.now()
        }

        alert('Annonce cr√©√©e avec succ√®s ! ‚úÖ\n\n' + photos.length + ' photo(s) ajout√©e(s)')
        console.log('Nouvelle annonce:', newAnnonce)

        // Reset form
        setFormData({
            titre: '',
            prix: '',
            categorie: 'immobilier',
            type: 'vente',
            ville: 'Libreville',
            description: '',
        })
        setPhotos([])
    }

    // Protection : seulement admin peut publier
    if (!user || user.role !== 'admin') {
        return (
            <div className="container mx-auto px-4 py-12 text-center">
                <div className="bg-red-100 border border-red-400 text-red-700 px-8 py-6 rounded-lg max-w-md mx-auto">
                    <h2 className="text-2xl font-bold mb-4">‚ö†Ô∏è Acc√®s refus√©</h2>
                    <p className="mb-4">Seul l'administrateur peut publier des annonces.</p>
                    <button
                        onClick={() => navigate('/login')}
                        className="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition"
                    >
                        Se connecter
                    </button>
                </div>
            </div>
        )
    }

    return (
        <div className="container mx-auto px-4 py-12 max-w-2xl">
            <h1 className="text-3xl font-bold mb-8">Publier une annonce</h1>

            <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                    <label className="block mb-2 font-semibold">Titre</label>
                    <input
                        type="text"
                        required
                        className="w-full border rounded-lg px-4 py-2"
                        value={formData.titre}
                        onChange={(e) => setFormData({ ...formData, titre: e.target.value })}
                    />
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block mb-2 font-semibold">Cat√©gorie</label>
                        <select
                            className="w-full border rounded-lg px-4 py-2"
                            value={formData.categorie}
                            onChange={(e) => setFormData({ ...formData, categorie: e.target.value })}
                        >
                            {CATEGORIES.map(cat => <option key={cat.key} value={cat.key}>{cat.label}</option>)}
                        </select>
                    </div>

                    <div>
                        <label className="block mb-2 font-semibold">Type</label>
                        <select
                            className="w-full border rounded-lg px-4 py-2"
                            value={formData.type}
                            onChange={(e) => setFormData({ ...formData, type: e.target.value })}
                        >
                            <option value="vente">Vente</option>
                            <option value="location">Location</option>
                        </select>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block mb-2 font-semibold">Prix (FCFA)</label>
                        <input
                            type="number"
                            required
                            className="w-full border rounded-lg px-4 py-2"
                            value={formData.prix}
                            onChange={(e) => setFormData({ ...formData, prix: e.target.value })}
                        />
                    </div>

                    <div>
                        <label className="block mb-2 font-semibold">Ville</label>
                        <select
                            className="w-full border rounded-lg px-4 py-2"
                            value={formData.ville}
                            onChange={(e) => setFormData({ ...formData, ville: e.target.value })}
                        >
                            {VILLES.map(v => <option key={v} value={v}>{v}</option>)}
                        </select>
                    </div>
                </div>

                {/* Zone d'upload professionnelle */}
                <div>
                    <label className="block mb-2 font-semibold">Photos *</label>

                    <div
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                        className={`relative border-2 border-dashed rounded-xl p-8 text-center transition-all ${isDragging
                            ? 'border-primary bg-primary/10 scale-105'
                            : 'border-gray-300 hover:border-primary hover:bg-gray-50'
                            }`}
                    >
                        <input
                            type="file"
                            accept="image/*"
                            multiple
                            onChange={handleImageUpload}
                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                        />

                        <div className="pointer-events-none">
                            <div className="mx-auto w-16 h-16 mb-4 bg-gradient-to-br from-primary to-secondary rounded-2xl flex items-center justify-center shadow-lg">
                                <Upload className="w-8 h-8 text-white" />
                            </div>

                            <p className="text-lg font-bold text-gray-800 mb-2">
                                {isDragging ? 'üì∏ D√©posez vos images ici' : 'Ajoutez vos photos'}
                            </p>

                            <p className="text-sm text-gray-600 mb-4">
                                Glissez-d√©posez ou cliquez pour parcourir
                            </p>

                            <div className="inline-flex items-center gap-2 bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                </svg>
                                Choisir des fichiers
                            </div>

                            <p className="text-xs text-gray-400 mt-4">
                                JPG, PNG, GIF ‚Ä¢ Jusqu'√† 10MB ‚Ä¢ Plusieurs fichiers accept√©s
                            </p>
                        </div>
                    </div>

                    {photos.length > 0 && (
                        <div className="mt-6">
                            <div className="flex items-center gap-2 mb-4">
                                <div className="bg-gradient-to-r from-primary to-secondary text-white w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold shadow-lg">
                                    {photos.length}
                                </div>
                                <p className="font-semibold text-gray-800">
                                    Photo{photos.length > 1 ? 's' : ''} s√©lectionn√©e{photos.length > 1 ? 's' : ''}
                                </p>
                            </div>

                            <div className="grid grid-cols-3 gap-4">
                                {photos.map((photo, index) => (
                                    <div key={index} className="relative group">
                                        <img
                                            src={photo.preview}
                                            alt={`Photo ${index + 1}`}
                                            className="w-full h-32 object-cover rounded-xl shadow-md group-hover:shadow-xl transition"
                                        />
                                        <button
                                            type="button"
                                            onClick={() => removePhoto(index)}
                                            className="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg hover:bg-red-600 hover:scale-110"
                                        >
                                            <X size={16} />
                                        </button>
                                        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent text-white text-xs p-3 rounded-b-xl truncate">
                                            {photo.name}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>

                <div>
                    <label className="block mb-2 font-semibold">Description</label>
                    <textarea
                        required
                        rows={5}
                        className="w-full border rounded-lg px-4 py-2"
                        value={formData.description}
                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                    />
                </div>

                <button
                    type="submit"
                    className="w-full bg-gradient-to-r from-primary to-secondary text-white py-4 rounded-lg hover:shadow-xl transition-all font-bold text-lg transform hover:scale-105"
                >
                    Publier l'annonce
                </button>
            </form>
        </div>
    )
}

function App() {
    return (
        <AuthProvider>
            <BrowserRouter>
                <div className="min-h-screen bg-gray-50">
                    <Navbar />
                    <Routes>
                        <Route path="/" element={<HomePage />} />
                        <Route path="/annonce/:id" element={<DetailAnnonce />} />
                        <Route path="/login" element={<LoginPage />} />
                        <Route path="/nouvelle-annonce" element={<NouvelleAnnonce />} />
                    </Routes>

                    <footer className="bg-gray-800 text-white py-8 mt-12">
                        <div className="container mx-auto px-4 text-center">
                            <p>¬© 2026 AUTO-IMMO - Petites Annonces Gabon</p>
                            <p className="text-sm text-gray-400 mt-2">üá¨üá¶ D√©velopp√© avec ‚ù§Ô∏è pour le Gabon</p>
                            <p className="text-xs text-gray-500 mt-1">D√©velopp√© par <span className="text-primary font-semibold">Ogoou√© Artificial Intelligence (Ogoou√© AI)</span></p>
                        </div>
                    </footer>
                </div>
            </BrowserRouter>
        </AuthProvider>
    )
}

export default App
